var e;var t=Object.defineProperty,o=(e,o,n)=>(((e,o,n)=>{o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[o]=n})(e,"symbol"!=typeof o?o+"":o,n),n);const n=()=>Date.now();let s=0,r=n();function i(){return s++,s===Number.MAX_SAFE_INTEGER&&(s=0,r=n()),`${r.toString(16)}-${s.toString(16)}`}class c{constructor(e,t){o(this,"context"),o(this,"_components"),o(this,"_entities",{}),o(this,"_componentAll",{}),o(this,"_systems",{}),o(this,"_entityRemove",new Set),o(this,"_componentRemove",{}),o(this,"_componentQueries",{}),o(this,"_queries",{}),this.context=e,this._components=t;for(const o in t)this._componentAll[o]=new Set,this._componentRemove[o]=new Set,this._componentQueries[o]=new Set}createEntity(e,t){const o=i(),n={__uuid:o};return e&&e.forEach((e=>this.addComponent(n,e,t?t[e]:void 0))),this._entities[o]=n,n}removeEntity(e){if(e){this._entityRemove.add(e.__uuid);for(const t of Object.keys(e))"__uuid"!==t&&this.removeComponent(e,t)}}addComponent(e,t,o){const n=Object.assign({},this._components[t],null!=o?o:{});return e[t]=n,this._componentAll[t].add(e.__uuid),this.updateComponents(t,e.__uuid,!0),e}removeComponent(e,t){this._componentAll[t].delete(e.__uuid),this._componentRemove[t].add(e.__uuid),this.updateComponents(t,e.__uuid,!1)}createQuery(e){const t=i(),o=new Set,n=new Set,s=new Set,r={},c={__uuid:t,add(t,s){r[s]&&(r[s].add(t),!o.has(t)&&e.every((e=>r[e].has(t)))&&(o.add(t),n.add(t)))},remove(t,i){r[i]&&(r[i].delete(t),o.has(t)&&!e.every((e=>r[e].has(t)))&&(o.delete(t),n.has(t)?n.delete(t):s.add(t)))}};for(const i of e)r[i]=new Set,this._componentAll[i].forEach((e=>c.add(e,i)));return this._queries[t]=c,e.forEach((e=>this._componentQueries[e].add(t))),()=>{const e={added:new Set([...n]),removed:new Set([...s]),entities:[...o].map((e=>this._entities[e]))};return n.clear(),s.clear(),e}}addSystem(e,t){const o=t(this);return o.mounted&&o.mounted(),this._systems[e]||(this._systems[e]=[]),this._systems[e].push(o),this._systems[e].sort(((e,t)=>(e.priority||1)-(t.priority||1))),t}updateSystems(e,t){const o=(Array.isArray(e)?e:[e]).map((e=>this._systems[e])).flat();for(const n of o)n.update&&n.update(t)}updateComponents(e,t,o){const n=t instanceof Set?t:new Set([t]);if(0===n.size)return;const s=e;for(const r of this._componentQueries[s]){const e=this._queries[r];for(const t of n)o?e.add(t,s):e.remove(t,s)}}cleanup(){for(const e in this._components){const t=this._componentRemove[e];0!==t.size&&(t.forEach((t=>{delete this._entities[t][e]})),t.clear())}if(this._entityRemove.size>0){for(const e of this._entityRemove)delete this._entities[e];this._entityRemove.clear()}}}const d=document.createElement("canvas");d.width=1280,d.height=720,d.style.background="transparent";const a=d.getContext("2d");if(null==(e=document.getElementById("app"))||e.appendChild(d),!a)throw new Error("");function m(){let e="#";for(let t=0;t<3;t++)e+=Math.floor(255*Math.random()).toString(16).padStart(2,"0");return e}function h(e){const t=a.createLinearGradient(0,0,1e3,1e3),o=e.length;let n=0;for(let s of e)t.addColorStop(n/(o-1),s),n++;return t}const u=new c({},{rect:{x:0,y:0,w:100,h:100,colors:["#FFFFFF","#000000"]},disc:{x:0,y:0,r:50,colors:["#FFFFFF","#000000"]},move:{dx:0,dy:0}});u.addSystem("move",(()=>{const e=u.createQuery(["rect","move"]),t=u.createQuery(["disc","move"]);return{name:"",update(o){const{entities:n}=e(),{entities:s}=t();for(const e of n)e.rect.x+=e.move.dx*o,e.rect.y+=e.move.dy*o,(e.rect.x<0||e.rect.x>1280-e.rect.w)&&(e.move.dx*=-1),(e.rect.y<0||e.rect.y>720-e.rect.h)&&(e.move.dy*=-1);for(const e of s)e.disc.x+=e.move.dx*o,e.disc.y+=e.move.dy*o,(e.disc.x<0||e.disc.x>1280-e.disc.r)&&(e.move.dx*=-1),(e.disc.y<0||e.disc.y>720-e.disc.r)&&(e.move.dy*=-1)}}})),u.addSystem("render",(()=>{const e=u.createQuery(["rect"]);return{name:"",update(){const{entities:t}=e();for(const e of t)a.beginPath(),a.fillStyle=h(e.rect.colors),a.fillRect(e.rect.x,e.rect.y,e.rect.w,e.rect.h),a.stroke()}}})),u.addSystem("render",(()=>{const e=u.createQuery(["disc"]);return{name:"",update(){const{entities:t}=e();for(const e of t)a.beginPath(),a.fillStyle=h(e.disc.colors),a.arc(e.disc.x,e.disc.y,e.disc.r,0,2*Math.PI),a.fill()}}}));const l=()=>[m(),m(),m(),m(),m()],y=()=>250*Math.random()+200;for(let f=0;f<50;f++)u.createEntity(["rect","move"],{rect:{x:y(),y:y(),colors:l()},move:{dx:Math.random()-.5,dy:Math.random()-.5}}),u.createEntity(["disc","move"],{disc:{x:y(),y:y(),r:60*Math.random()+10,colors:l()},move:{dx:Math.random()-.5,dy:Math.random()-.5}});let _=0;const p=e=>{const t=e-_;_=e,a.clearRect(0,0,d.width,d.height),u.updateSystems(["move","render"],t),requestAnimationFrame(p)};p(0);
